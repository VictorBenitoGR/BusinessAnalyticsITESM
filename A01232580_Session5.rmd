---
title: Session 5
author: "Victor Benito Garcia Rocha"
date: "2024-07-07"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
---

## <span style="color:#0000FF;">Part I. Load the libraries and import the excel file</span>

1.1 Rename the dataset to CCC, keep only the following variables: Annual_income, Type_income, EDUCATION, Marital_status. Print the header of CCC.

```{r}
library(readxl)
library(tidyverse)
library(ggplot2)
Credit_card_costumers <- read_excel(
  "Credit_card_costumersV2.xlsx"
)

Credit_card_costumers
```

```{r}
getwd()
CCC <- Credit_card_costumers %>%
  select(Annual_income, Type_Income, EDUCATION, Marital_status)
head(CCC)
```

## <span style="color:#0000FF;">Part II. Exploring the dataset</span>

2.1 Get a summary of all of the variables for CCC dataset to identify their characteristics. Verify that the variable “Annual_income” is a numeric one.

```{r}
summary(CCC)
```

```{r}
class(CCC$Annual_income)
```

2.2 “Annual_income” does not seem to be numeric. Since you want to present a statistical summary of it as well as a graph to describe it, you need to change it to a numeric variable. First, you need to use the str_remove_all to delete the “USD” word (create a variable for this: Annual_income_trimmed), then, make it numeric (creare another variable: Annual_income_usd). After you solve that, get a histogram for that variable with labels in each axis and main title.

```{r}
CCC <- CCC %>%
  mutate(Annual_income_trimmed = (str_remove(Annual_income, "USD"))) %>%
  mutate(Annual_income_usd = as.numeric(Annual_income_trimmed)) %>%
  select(Annual_income_usd, Type_Income, EDUCATION, Marital_status)

CCC %>%
  ggplot(aes(x = Annual_income_usd)) +
  geom_histogram(color = "white", fill = "#034400", bins = 15) +
  theme_minimal()
```

<span style="color: red;">**What can you say about the skewness in this graph? Explain**</span>

The majority of the data is concentrated on the left side of the histogram. This indicates that most of the people have lower annual incomes, while a few individuals have **much higher** incomes.

## <span style="color:#0000FF;">Part III. Detecting and dealing with outliers</span>

3.1 Build a boxplot for the Annual_income_usd variable to identify potential outliers.

```{r}
CCC %>%
  ggplot(aes(y = Annual_income_usd)) +
  geom_boxplot(fill = "#d13bff") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  labs(y = "Annual income in USD", title = "Boxplot of Annual income")
```

<span style="color: red;">**Do you notice any outliers in the dataset? Answer here**</span>

The boxplot clearly shows the presence of several outliers in the data, with a significant number of individuals earning much higher incomes than the majority, contributing to the last right-skewed distribution.

```{r}
# Identify the outliers (there are 73 in total):
boxplot(CCC$Annual_income_usd)$out
```

```{r}
# Create an object ("out") that will keep the observations considered outliers. After that, create "out_index", this object will extract the outliers to properly identify them in the dataset.
out <- boxplot.stats(CCC$Annual_income_usd)$out
out_index <- which(CCC$Annual_income_usd %in% c(out))
CCC[out_index, ]
```

3.2 Find and show any observation with NA’s in Annual_income_usd.

```{r}
CCC[is.na(CCC$Annual_income_usd), ]
```

3.3 Calculate the Interquartile Range for Annual_income_usd using the function IQR, remove any NA. Create an object to save the result IQR_AI, print the result.

```{r}
IQR_AI <- IQR(CCC$Annual_income_usd, na.rm = TRUE)
IQR_AI
```

<span style="color: red;">**What is the IQR? Explain in your own words**</span>

The Interquartile Range (IQR) measures the spread of the middle 50% of data and is calculated as the difference between the third and first quartiles, giving a good measure of variability by showing the range within which the central half of the data lies.

3.4 One popular technique to deal with outliers is to replace them with the mean or median of the variable. For the variable Annual_income_usd, replace any observation above Quartile3 + 1.5*IQR with the mean, create a new variable to do that: Annual_income_usd_mean. You can use the function quantile to get the quartiles, save Quartile 3 into an object Q3_AI.

```{r}
quantile(CCC$Annual_income_usd, na.rm = TRUE)
```

```{r}
Q3_AI <- 225000
CCC %>%
  mutate(Annual_income_usd_mean = replace(Annual_income_usd, Annual_income_usd > Q3_AI + 1.5 * IQR_AI, mean(CCC$Annual_income_usd, na.rm = TRUE))) %>%
  drop_na() %>%
  select(Annual_income_usd, Annual_income_usd_mean)
```

3.5 Another popular technique is to remove the outliers. It is better to create a safety copy of the dataset instead of changing the original one. Create a safety copy for CCC: CCC_deleted, for this, remove the outliers.Show the header of the new object.

```{r}
CCC_deleted <- CCC[-c(out_index), ]
head(CCC_deleted)
```

3.6 Now, determine how many NA’s you have for Annual_income_usd, then, drop them and create a new dataset: CCC_deleted_complete.

```{r}
sum(is.na(CCC_deleted$Annual_income_usd))
```

```{r}
CCC_deleted_complete <- CCC_deleted %>%
  drop_na(Annual_income_usd)

head(CCC_deleted_complete)
```

3.7 Now, create a new boxplot, histogram (with 15 bins) and density plot that shows a line for the mean value, all for annual_income_usd variable.

```{r}
options(scipen = 999) # This will avoid scientific notation in the numbers of the graph
CCC_deleted_complete %>%
  ggplot(aes(y = Annual_income_usd)) +
  geom_boxplot(fill = "#8f0039")
```

```{r}
CCC_deleted_complete %>%
  ggplot(aes(x = Annual_income_usd)) +
  geom_histogram(color = "#440000", fill = "#ee90b7", bins = 15)
```

```{r}
CCC_deleted_complete %>%
  ggplot(aes(x = Annual_income_usd)) +
  geom_density() +
  geom_vline(aes(xintercept = mean(Annual_income_usd)), color = "#767000", linetype = "dashed", size = 1) +
  theme_minimal()
```

## <span style="color:#0000FF;">Part IV. Modeling the relationship between three variables</span>

4.1 Prepare a table (with margins) that shows the relationship between the variable Marital Status Vs Education Level, that is, this table should describe the amount of people inside each category, for instance, how many people with higher education are married, single, etc. Add a mosaic plot to present the information.

```{r}
Ed_Vs_Marital <- table(CCC$EDUCATION, CCC$Marital_status) %>%
  addmargins()
Ed_Vs_Marital
```

4.2 Finally, create a graph that shows in the x axis, the education level, in the y axis, the annual income in usd, and it is filled with the marital status variable.

```{r}
Ed_Vs_Marital_df <- data.frame(Ed_Vs_Marital)

ggplot(CCC_deleted_complete, aes(
  fill = Marital_status, x = EDUCATION, y = Annual_income_usd
)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(axis.text.x = element_text(size = rel(0.9), angle = 45, hjust = 1)) +
  labs(
    x = "Education level", y = "Annual income in USD", fill = "Marital status"
  ) +
  scale_fill_brewer(palette = "Set3")
```

<span style="color: red;">**Describe what you see in this graph**</span>

- Academic degree: The lowest income for civil marriages and the highest for those who are single or not married. The plot doesn't show anything about the others.
- Higher education: Generally high incomes across all marital statuses, with single/not married having the lowest incomes.
- Incomplete higher: Moderate to high incomes, with civil marriage and married individuals showing the highest ones.
- Lower secondary: Lower incomes compared to the others levels, with single/not married showing the lowest.
- Secondary: The highest incomes in the plot.

```{r, include=FALSE}
# rmarkdown::render(
#   "./src/A01232580_Session5.Rmd",
#   output_format = rmarkdown::pdf_document(),
#   output_dir = "./docs/"
# )

# rmarkdown::render(
#   "./src/A01232580_Session5.Rmd",
#   output_format = "html_document",
#   output_dir = "./docs/"
# )
```